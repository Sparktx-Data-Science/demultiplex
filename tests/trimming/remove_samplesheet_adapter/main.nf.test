nextflow_pipeline {

    name "Trimming - Remove Adapter"
    script "../../../main.nf"
    profile "test"
    tag "remove_samplesheet_adapter"
    tag "pipeline"

    test("User wants to skip trimming with the demultiplexer, and trim with fastp") {
        when {
            params {
                input         = "${projectDir}/tests/trimming/remove_samplesheet_adapter/samplesheets/input_samplesheet.csv"
                outdir        = "$outputDir"
                skip_tools = 'samshee,falco' // Skip samshee validation which fails on our test samplesheets
                // NOTE: This is the default behavior, so we don't need to set these params but leaving them here for clarity
                // remove_samplesheet_adapter = true
                // trim_fastq    = true
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                // Check that generated samplesheet has no adapter lines
                {
                    def samplesheetFiles = file("$outputDir").listFiles().findAll { it.name.endsWith('_no_adapters.csv') }
                    assert samplesheetFiles.size() > 0
                    def adapterlinesFound = false
                    samplesheetFiles.each { file ->
                        def content = file.text
                        if (content.contains('AdapterRead1') || content.contains('AdapterRead2') ||
                            content.contains('Adapter,AGATCGGAAGAG')) {
                            adapterlinesFound = true
                        }
                    }
                    assert !adapterlinesFound
                }
            )
        }
    }
    test("User wants to trim with the demultiplexer") {
        when {
            params {
                input         = "${projectDir}/tests/trimming/remove_samplesheet_adapter/samplesheets/input_samplesheet.csv"
                outdir        = "$outputDir"
                skip_tools = 'samshee,falco' // Skip samshee validation which fails on our test samplesheets
                remove_samplesheet_adapter = false
                trim_fastq = false
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                // Check that generated samplesheet has no adapter lines
                {
                    def samplesheetFiles = file("$outputDir").listFiles().findAll { it.name.endsWith('_no_adapters.csv') }
                    assert samplesheetFiles.size() > 0
                    def adapterlinesFound = false
                    samplesheetFiles.each { file ->
                        def content = file.text
                        if (content.contains('AdapterRead1') || content.contains('AdapterRead2') ||
                            content.contains('Adapter,AGATCGGAAGAG')) {
                            adapterlinesFound = true
                        }
                    }
                    assert !adapterlinesFound
                }
            )
        }
    }

    test("User wants to skip trimming all together") {
        when {
            params {
                input         = "${projectDir}/tests/trimming/remove_samplesheet_adapter/samplesheets/input_samplesheet.csv"
                outdir        = "$outputDir"
                skip_tools = 'samshee,falco' // Skip samshee validation which fails on our test samplesheets
                remove_samplesheet_adapter = false
                trim_fastq = false
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                // Check that generated samplesheet has no adapter lines
                {
                    def samplesheetFiles = file("$outputDir").listFiles().findAll { it.name.endsWith('_no_adapters.csv') }
                    assert samplesheetFiles.size() > 0
                    def adapterlinesFound = false
                    samplesheetFiles.each { file ->
                        def content = file.text
                        if (content.contains('AdapterRead1') || content.contains('AdapterRead2') ||
                            content.contains('Adapter,AGATCGGAAGAG')) {
                            adapterlinesFound = true
                        }
                    }
                    assert !adapterlinesFound
                }
            )
        }
    }

    // TODO: When would someone want to run this? Should this fail?
    // test("User wants to trim with the demultiplexer, and trim with fastp") {
    // }
}
